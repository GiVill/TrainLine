<div class="sidebar">
  <!-- ───── Header / Back button ───── -->
  <div class="sidebar-header">
    @if (showBackButton()) {
      <button class="back-button" (click)="onBackClick()">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="15,18 9,12 15,6"></polyline>
        </svg>
        Back to Stations
      </button>
    } @else {
      <h2>Network Overview</h2>
    }
  </div>

  @if (!showBackButton()) {
    <!-- ───── Search Bar ───── -->
    <div class="search-container">
      <input type="text" class="search-input"
             placeholder="Search stations, routes…"
             [value]="searchTerm()"
             (input)="onSearchChange($any($event.target).value)" />
      <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <circle cx="11" cy="11" r="8"></circle>
        <path d="m21 21-4.35-4.35"></path>
      </svg>
    </div>

    <!-- ───── Category Tabs ───── -->
    <div class="category-tabs">
      <button class="tab-button" [class.active]="activeCategory() === 'stations'" (click)="onCategoryChange('stations')">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="3"></circle>
        </svg>
        Stazioni
      </button>
      <button class="tab-button" [class.active]="activeCategory() === 'routes'" (click)="onCategoryChange('routes')">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M3 12h18m-9-9l9 9-9 9"></path>
        </svg>
        Tratte
      </button>
    </div>

    <!-- ───── Zone Filter ───── -->
    <div class="zone-filter-section">
      <div class="zone-filter-header">
        <span class="filter-label">Filtra per Zona</span>
        @if (selectedZone() !== 'all') {
          <button class="clear-zone-button" (click)="onZoneSelect('all')">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
            Azzera
          </button>
        }
      </div>
      <div class="zone-selector">
        <select class="zone-dropdown" [value]="selectedZone()" (change)="onZoneSelect($any($event.target).value)">
          <option value="all">Tutte le zone</option>
          @for (zone of availableZones(); track zone) {
            <option [value]="zone">Zona {{ zone }}</option>
          }
        </select>
        <svg class="dropdown-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <polyline points="6,9 12,15 18,9"></polyline>
        </svg>
      </div>
    </div>

    <!-- ───── Content Section ───── -->
    <div class="content-section">
      <div class="section-header">
        @if (activeCategory() === 'stations') {
          <h3>STAZIONI</h3><span class="count-badge">{{ filteredStations().length }}</span>
        } @else {
          <h3>TRATTE</h3><span class="count-badge">{{ filteredRoutes().length }}</span>
        }
      </div>

      @if (loading()) {
        <div class="loading-state"><div class="loading-spinner"></div><p>Caricamento…</p></div>
      }
      @if (error()) {
        <div class="error-state"><p>{{ error() }}</p><button (click)="ngOnInit()">Riprova</button></div>
      }

      @if (!loading() && !error()) {
        <!-- ────────── Stations List ────────── -->
        @if (activeCategory() === 'stations') {
          <div class="items-list">
            @for (station of filteredStations(); track station.stop_id) {
              <div class="station-item" tabindex="0" role="button" (click)="onStationClick(station)">
                <div class="item-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle></svg></div>
                <div class="item-info">
                  <div class="item-name">{{ station.stop_name }}</div>
                  <div class="item-details"><span class="zone-badge">Zona {{ station.zone_id }}</span></div>
                </div>
                <div class="item-arrow"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9,18 15,12 9,6"></polyline></svg></div>
              </div>
            } @empty {
              <p class="no-results">Nessuna stazione trovata</p>
            }
          </div>
        }

        <!-- ────────── Routes List ────────── -->
        @if (activeCategory() === 'routes') {
          <div class="items-list">
            @for (route of filteredRoutes(); track route.shapeId) {
              <div class="route-item-container">
                <div class="route-item" tabindex="0" role="button" (click)="onRouteClick(route)">
                  <div class="item-icon"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12h18m-9-9l9 9-9 9"></path></svg></div>
                  <div class="item-info">
                    <div class="item-name">{{ route.name }}</div>
                    <div class="item-details">
                      <span class="stations-count">{{ route.stops.length }} fermate</span>
                      <span class="route-summary" *ngIf="!route.expanded">{{ route.origin.stop_name }} → {{ route.destination.stop_name }}</span>
                    </div>
                  </div>
                  <div class="item-arrow" [class.expanded]="route.expanded"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6,9 12,15 18,9"></polyline></svg></div>
                </div>

                @if (route.expanded) {
                  <div class="route-details">
                    <div class="detail-row"><span class="detail-label">Partenza</span><span class="detail-value">{{ route.origin.stop_name }}</span></div>
                    <div class="detail-row"><span class="detail-label">Arrivo</span><span class="detail-value">{{ route.destination.stop_name }}</span></div>
                    <div class="detail-row"><span class="detail-label">Fermate</span><span class="detail-value">{{ route.stops.length }}</span></div>
                  </div>
                }
              </div>
            } @empty {
              <p class="no-results">Nessuna tratta trovata</p>
            }
          </div>
        }
      }
    </div>
  }
</div>
